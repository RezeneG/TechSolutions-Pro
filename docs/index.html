<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechSolutions Pro | IT Services & Training Marketplace</title>
    <meta name="description" content="Professional IT services and training programs. Transform your business with our expert solutions.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (ALL YOUR EXISTING CSS STYLES REMAIN UNCHANGED) ... */
        /* Keep all the CSS styles you already have */
    </style>
</head>
<body>
    <!-- ... (ALL YOUR EXISTING HTML STRUCTURE REMAINS UNCHANGED) ... -->
    <!-- Keep all the HTML structure you already have -->

    <script>
        // =============================================
        // API CONFIGURATION
        // =============================================
        const API_BASE_URL = 'http://localhost:5000/api';

        // API endpoints
        const API_ENDPOINTS = {
            // Authentication
            REGISTER: `${API_BASE_URL}/auth/register`,
            LOGIN: `${API_BASE_URL}/auth/login`,
            
            // Data
            SERVICES: `${API_BASE_URL}/services`,
            COURSES: `${API_BASE_URL}/courses`,
            PRODUCTS: `${API_BASE_URL}/products`,
            USERS: `${API_BASE_URL}/users`,
            
            // User actions
            ENROLL_COURSE: (userId, courseId) => `${API_BASE_URL}/users/${userId}/enroll/${courseId}`,
            UPDATE_PROFILE: (userId) => `${API_BASE_URL}/users/${userId}`,
            SERVICE_REQUEST: `${API_BASE_URL}/service-requests`,
            ORDERS: `${API_BASE_URL}/orders`
        };

        // =============================================
        // API SERVICE FUNCTIONS
        // =============================================

        // Generic API call function
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Authentication API calls
        async function registerUser(userData) {
            const result = await apiCall(API_ENDPOINTS.REGISTER, {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Registration failed');
            }
        }

        async function loginUser(credentials) {
            const result = await apiCall(API_ENDPOINTS.LOGIN, {
                method: 'POST',
                body: JSON.stringify(credentials)
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Login failed');
            }
        }

        // Data API calls with correct response extraction
        async function fetchServices() {
            const result = await apiCall(API_ENDPOINTS.SERVICES);
            
            if (result.success && result.services) {
                return result.services;
            } else if (Array.isArray(result)) {
                return result;
            } else {
                console.warn('Unexpected services response format:', result);
                return [];
            }
        }

        async function fetchCourses() {
            const result = await apiCall(API_ENDPOINTS.COURSES);
            
            if (result.success && result.courses) {
                return result.courses;
            } else if (Array.isArray(result)) {
                return result;
            } else {
                console.warn('Unexpected courses response format:', result);
                return [];
            }
        }

        async function fetchProducts() {
            const result = await apiCall(API_ENDPOINTS.PRODUCTS);
            
            if (result.success && result.products) {
                return result.products;
            } else if (Array.isArray(result)) {
                return result;
            } else {
                console.warn('Unexpected products response format:', result);
                return [];
            }
        }

        // User action API calls
        async function enrollInCourse(userId, courseId) {
            const result = await apiCall(API_ENDPOINTS.ENROLL_COURSE(userId, courseId), {
                method: 'POST'
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Enrollment failed');
            }
        }

        async function updateUserProfile(userId, profileData) {
            const result = await apiCall(API_ENDPOINTS.UPDATE_PROFILE(userId), {
                method: 'PUT',
                body: JSON.stringify(profileData)
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Profile update failed');
            }
        }

        async function createServiceRequest(requestData) {
            const result = await apiCall(API_ENDPOINTS.SERVICE_REQUEST, {
                method: 'POST',
                body: JSON.stringify(requestData)
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Service request failed');
            }
        }

        async function createOrder(orderData) {
            const result = await apiCall(API_ENDPOINTS.ORDERS, {
                method: 'POST',
                body: JSON.stringify(orderData)
            });
            
            if (result.success) {
                return result;
            } else {
                throw new Error(result.message || 'Order creation failed');
            }
        }

        // =============================================
        // AUTHENTICATION SYSTEM
        // =============================================
        
        // Authentication State Management
        let currentUser = null;
        const AUTH_TOKEN_KEY = 'techsolutions_auth_token';
        const USER_DATA_KEY = 'techsolutions_user_data';

        // Initialize authentication
        function initAuth() {
            try {
                const token = localStorage.getItem(AUTH_TOKEN_KEY);
                const userData = localStorage.getItem(USER_DATA_KEY);
                
                if (token && userData) {
                    currentUser = JSON.parse(userData);
                    updateAuthUI();
                    showToast('Welcome back!', 'success');
                }
            } catch (error) {
                console.error('Error initializing authentication:', error);
                localStorage.removeItem(AUTH_TOKEN_KEY);
                localStorage.removeItem(USER_DATA_KEY);
            }
        }

        // Update UI based on authentication state
        function updateAuthUI() {
            try {
                const authButtons = document.getElementById('auth-buttons');
                const navSigninBtn = document.querySelector('.nav-links .btn-primary');
                
                if (currentUser) {
                    if (navSigninBtn) {
                        navSigninBtn.style.display = 'none';
                    }
                    
                    authButtons.innerHTML = `
                        <div class="user-menu">
                            <div class="user-avatar" onclick="toggleUserDropdown()">
                                ${getUserInitials(currentUser.name)}
                            </div>
                            <div class="user-dropdown" id="user-dropdown">
                                <a href="#" class="user-dropdown-item" onclick="showDashboard()">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                                <a href="#" class="user-dropdown-item" onclick="showDashboardTab('profile')">
                                    <i class="fas fa-user"></i> Profile
                                </a>
                                <a href="#" class="user-dropdown-item">
                                    <i class="fas fa-cog"></i> Settings
                                </a>
                                <div class="user-dropdown-divider"></div>
                                <a href="#" class="user-dropdown-item" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    if (navSigninBtn) {
                        navSigninBtn.style.display = 'inline-block';
                    }
                    
                    authButtons.innerHTML = `
                        <a href="#" class="btn btn-outline" onclick="openAuthModal('login')">Login</a>
                        <a href="#" class="btn btn-primary" onclick="openAuthModal('register')">Sign Up</a>
                    `;
                }
            } catch (error) {
                console.error('Error updating auth UI:', error);
                document.getElementById('auth-buttons').innerHTML = `
                    <a href="#" class="btn btn-outline" onclick="openAuthModal('login')">Login</a>
                    <a href="#" class="btn btn-primary" onclick="openAuthModal('register')">Sign Up</a>
                `;
            }
        }

        // Authentication Functions
        function openAuthModal(formType = 'login') {
            try {
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('authModal').setAttribute('aria-hidden', 'false');
                showAuthForm(formType);
            } catch (error) {
                console.error('Error opening auth modal:', error);
                showToast('Unable to open login form. Please try again.', 'error');
            }
        }

        function closeAuthModal() {
            try {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('authModal').setAttribute('aria-hidden', 'true');
                resetAuthForms();
            } catch (error) {
                console.error('Error closing auth modal:', error);
            }
        }

        function showAuthForm(formType) {
            try {
                document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                
                const headerTitle = document.getElementById('authModalTitle');
                const headerSubtitle = document.querySelector('.auth-header p');
                
                if (formType === 'login') {
                    headerTitle.textContent = 'Welcome to TechSolutions Pro';
                    headerSubtitle.textContent = 'Sign in to your account or create a new one';
                    document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
                } else if (formType === 'register') {
                    headerTitle.textContent = 'Create Your Account';
                    headerSubtitle.textContent = 'Join thousands of IT professionals and businesses';
                    document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
                } else if (formType === 'forgot-password') {
                    headerTitle.textContent = 'Reset Your Password';
                    headerSubtitle.textContent = 'Enter your email to receive a reset link';
                }
                
                document.getElementById(`${formType}-form`).classList.add('active');
            } catch (error) {
                console.error('Error showing auth form:', error);
                showToast('Unable to load form. Please refresh the page.', 'error');
            }
        }

        function resetAuthForms() {
            try {
                document.getElementById('login-form').reset();
                document.getElementById('register-form').reset();
                document.getElementById('forgot-password-form').reset();
                document.getElementById('password-strength').textContent = '';
            } catch (error) {
                console.error('Error resetting auth forms:', error);
            }
        }

        // Password visibility toggle
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentNode.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Login Function with API Integration
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            button.disabled = true;
            
            try {
                const result = await loginUser({ email, password });
                
                if (result.success) {
                    currentUser = result.user;
                    
                    localStorage.setItem(AUTH_TOKEN_KEY, result.token);
                    localStorage.setItem(USER_DATA_KEY, JSON.stringify(currentUser));
                    
                    if (!rememberMe) {
                        setTimeout(() => {
                            logout();
                        }, 24 * 60 * 60 * 1000);
                    }
                    
                    updateAuthUI();
                    closeAuthModal();
                    showToast('Login successful!', 'success');
                } else {
                    throw new Error(result.message || 'Login failed');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // Registration Function with API Integration
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            button.disabled = true;
            
            try {
                const result = await registerUser({ name, email, password });
                
                if (result.success) {
                    currentUser = result.user;
                    
                    localStorage.setItem(AUTH_TOKEN_KEY, result.token);
                    localStorage.setItem(USER_DATA_KEY, JSON.stringify(currentUser));
                    
                    updateAuthUI();
                    closeAuthModal();
                    showToast('Account created successfully!', 'success');
                } else {
                    throw new Error(result.message || 'Registration failed');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // Password Strength Checker
        function checkPasswordStrength(password) {
            try {
                const strengthText = document.getElementById('password-strength');
                let strength = 0;
                
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                strengthText.className = 'password-strength';
                
                if (password.length === 0) {
                    strengthText.textContent = '';
                } else if (strength < 2) {
                    strengthText.textContent = 'Weak password';
                    strengthText.classList.add('strength-weak');
                } else if (strength < 4) {
                    strengthText.textContent = 'Medium strength';
                    strengthText.classList.add('strength-medium');
                } else {
                    strengthText.textContent = 'Strong password';
                    strengthText.classList.add('strength-strong');
                }
            } catch (error) {
                console.error('Error checking password strength:', error);
            }
        }

        // Forgot Password
        document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgot-email').value;
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            button.disabled = true;
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                showToast('Password reset link sent to your email', 'success');
                showAuthForm('login');
            } catch (error) {
                showToast('Error sending reset link', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // =============================================
        // DATA LOADING FUNCTIONS
        // =============================================

        // Load services with API integration
        async function loadServices() {
            const container = document.getElementById('services-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const services = await fetchServices();
                
                const searchTerm = document.getElementById('service-search').value.toLowerCase();
                const categoryFilter = document.getElementById('service-category').value;
                
                const filteredServices = services.filter(service => {
                    const matchesSearch = service.name.toLowerCase().includes(searchTerm) || 
                                        service.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = categoryFilter === 'all' || service.category === categoryFilter;
                    return matchesSearch && matchesCategory;
                });
                
                container.innerHTML = '';
                
                if (filteredServices.length === 0) {
                    container.innerHTML = `
                        <div class="error-fallback" style="grid-column: 1 / -1;">
                            <i class="fas fa-search"></i>
                            <h3>No Services Found</h3>
                            <p>No services match your search criteria. Try adjusting your filters or search terms.</p>
                            <button class="btn btn-primary" onclick="document.getElementById('service-search').value=''; document.getElementById('service-category').value='all'; loadServices()">
                                Reset Filters
                            </button>
                        </div>
                    `;
                    return;
                }
                
                filteredServices.forEach(service => {
                    const serviceCard = document.createElement('div');
                    serviceCard.className = 'service-card';
                    serviceCard.innerHTML = `
                        <div class="service-icon">
                            <i class="fas ${getServiceIcon(service.category)}"></i>
                        </div>
                        <div class="service-content">
                            <h3>${service.name}</h3>
                            <p>${service.description}</p>
                            <ul class="service-features">
                                ${service.features ? service.features.map(feature => 
                                    `<li><i class="fas fa-check"></i> ${feature}</li>`
                                ).join('') : '<li><i class="fas fa-check"></i> Comprehensive Service</li>'}
                            </ul>
                            <div class="service-price">${service.price || 'Contact for pricing'}</div>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showServiceDetails('${service._id}')">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="btn btn-primary" onclick="getStarted('${service._id}')">
                                    Get Started
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(serviceCard);
                });
            } catch (error) {
                console.error('Failed to load services:', error);
                container.innerHTML = `
                    <div class="error-fallback" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to Load Services</h3>
                        <p>There was an error loading our services. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadServices()">Retry</button>
                    </div>
                `;
            }
        }

        // Load courses with API integration
        async function loadCourses() {
            const container = document.getElementById('courses-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const courses = await fetchCourses();
                
                const searchTerm = document.getElementById('course-search').value.toLowerCase();
                const levelFilter = document.getElementById('course-level').value;
                
                const filteredCourses = courses.filter(course => {
                    const matchesSearch = course.name.toLowerCase().includes(searchTerm) || 
                                        course.description.toLowerCase().includes(searchTerm);
                    const matchesLevel = levelFilter === 'all' || course.level.toLowerCase() === levelFilter;
                    return matchesSearch && matchesLevel;
                });
                
                container.innerHTML = '';
                
                if (filteredCourses.length === 0) {
                    container.innerHTML = `
                        <div class="error-fallback" style="grid-column: 1 / -1;">
                            <i class="fas fa-search"></i>
                            <h3>No Courses Found</h3>
                            <p>No courses match your search criteria. Try adjusting your filters or search terms.</p>
                            <button class="btn btn-primary" onclick="document.getElementById('course-search').value=''; document.getElementById('course-level').value='all'; loadCourses()">
                                Reset Filters
                            </button>
                        </div>
                    `;
                    return;
                }
                
                filteredCourses.forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.className = 'course-card';
                    courseCard.innerHTML = `
                        <div class="course-image" style="background-image: url('${course.image || 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}')">
                            ${course.badge ? `<div class="course-badge">${course.badge}</div>` : ''}
                        </div>
                        <div class="course-content">
                            <h3>${course.name}</h3>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span><i class="fas fa-clock"></i> ${course.duration}</span>
                                <span><i class="fas fa-user-graduate"></i> ${course.enrolled || 0} enrolled</span>
                                <span class="course-rating"><i class="fas fa-star"></i> ${course.rating || 4.5}</span>
                            </div>
                            <div style="margin-bottom: 15px; font-size: 0.9rem; color: var(--gray);">
                                <i class="fas fa-signal"></i> ${course.level}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showCourseDetails('${course._id}')">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="btn btn-primary" onclick="enrollNow('${course._id}')">
                                    Enroll Now
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(courseCard);
                });
            } catch (error) {
                console.error('Failed to load courses:', error);
                container.innerHTML = `
                    <div class="error-fallback" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to Load Courses</h3>
                        <p>There was an error loading our course catalog. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadCourses()">Retry</button>
                    </div>
                `;
            }
        }

        // Load products with API integration
        async function loadProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const products = await fetchProducts();
                
                const searchTerm = document.getElementById('product-search').value.toLowerCase();
                const categoryFilter = document.getElementById('product-category').value;
                
                const filteredProducts = products.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                        product.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
                    return matchesSearch && matchesCategory;
                });
                
                container.innerHTML = '';
                
                if (filteredProducts.length === 0) {
                    container.innerHTML = `
                        <div class="error-fallback" style="grid-column: 1 / -1;">
                            <i class="fas fa-search"></i>
                            <h3>No Products Found</h3>
                            <p>No products match your search criteria. Try adjusting your filters or search terms.</p>
                            <button class="btn btn-primary" onclick="document.getElementById('product-search').value=''; document.getElementById('product-category').value='all'; loadProducts()">
                                Reset Filters
                            </button>
                        </div>
                    `;
                    return;
                }
                
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <div class="product-image" style="background-image: url('${product.image || 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}')">
                            ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                        </div>
                        <div class="product-content">
                            <h3>${product.name}</h3>
                            <p>${product.description}</p>
                            <ul class="product-features">
                                ${product.features ? product.features.map(feature => 
                                    `<li><i class="fas fa-check"></i> ${feature}</li>`
                                ).join('') : '<li><i class="fas fa-check"></i> High Quality Product</li>'}
                            </ul>
                            <div class="product-meta">
                                <span class="product-rating">
                                    <i class="fas fa-star"></i> ${product.rating || 4.5} (${product.reviews || 0})
                                </span>
                                <span>
                                    <i class="fas fa-tag"></i> ${product.category.charAt(0).toUpperCase() + product.category.slice(1)}
                                </span>
                            </div>
                            <div class="product-price">
                                <span class="current-price">${product.price}</span>
                                ${product.originalPrice ? `<span class="original-price">${product.originalPrice}</span>` : ''}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showProductDetails('${product._id}')">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button class="btn btn-primary" onclick="addToCart('${product._id}')">
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(productCard);
                });
            } catch (error) {
                console.error('Failed to load products:', error);
                container.innerHTML = `
                    <div class="error-fallback" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to Load Products</h3>
                        <p>There was an error loading our products. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadProducts()">Retry</button>
                    </div>
                `;
            }
        }

        // Show service details in modal
        async function showServiceDetails(serviceId) {
            try {
                const services = await fetchServices();
                const service = services.find(s => s._id === serviceId);
                
                if (!service) {
                    showToast('Service not found', 'error');
                    return;
                }
                
                document.getElementById('serviceModalTitle').textContent = service.name;
                document.getElementById('serviceModalBody').innerHTML = `
                    <p><strong>Description:</strong> ${service.details || service.description}</p>
                    <p><strong>Price:</strong> ${service.price}</p>
                    <p><strong>Category:</strong> ${service.category ? service.category.charAt(0).toUpperCase() + service.category.slice(1) : 'General'}</p>
                    <p><strong>Features:</strong></p>
                    <ul>
                        ${service.features ? service.features.map(feature => `<li>${feature}</li>`).join('') : '<li>No features listed</li>'}
                    </ul>
                `;
                document.getElementById('serviceModalAction').textContent = 'Get Started';
                document.getElementById('serviceModalAction').onclick = function() { getStarted(serviceId); };
                
                openModal('serviceModal');
            } catch (error) {
                console.error('Error showing service details:', error);
                showToast('Unable to load service details. Please try again.', 'error');
            }
        }

        // Show course details in modal
        async function showCourseDetails(courseId) {
            try {
                const courses = await fetchCourses();
                const course = courses.find(c => c._id === courseId);
                
                if (!course) {
                    showToast('Course not found', 'error');
                    return;
                }
                
                document.getElementById('courseModalTitle').textContent = course.name;
                document.getElementById('courseModalBody').innerHTML = `
                    <p><strong>Description:</strong> ${course.details || course.description}</p>
                    <p><strong>Duration:</strong> ${course.duration}</p>
                    <p><strong>Level:</strong> ${course.level}</p>
                    <p><strong>Price:</strong> ${course.price}</p>
                    <p><strong>Rating:</strong> ${course.rating || 4.5}/5 (${course.enrolled || 0} enrolled)</p>
                `;
                document.getElementById('courseModalAction').textContent = 'Enroll Now';
                document.getElementById('courseModalAction').onclick = function() { enrollNow(courseId); };
                
                openModal('courseModal');
            } catch (error) {
                console.error('Error showing course details:', error);
                showToast('Unable to load course details. Please try again.', 'error');
            }
        }

        // Show product details in modal
        async function showProductDetails(productId) {
            try {
                const products = await fetchProducts();
                const product = products.find(p => p._id === productId);
                
                if (!product) {
                    showToast('Product not found', 'error');
                    return;
                }
                
                document.getElementById('productModalTitle').textContent = product.name;
                document.getElementById('productModalBody').innerHTML = `
                    <div class="product-details">
                        <div class="product-gallery">
                            <div class="product-main-image" style="background-image: url('${product.image || 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'}')">
                            </div>
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-meta">
                                <span class="product-rating">
                                    <i class="fas fa-star"></i> ${product.rating || 4.5} (${product.reviews || 0} reviews)
                                </span>
                                <span>
                                    <i class="fas fa-tag"></i> ${product.category.charAt(0).toUpperCase() + product.category.slice(1)}
                                </span>
                            </div>
                            <div class="product-price" style="margin: 15px 0;">
                                <span class="current-price" style="font-size: 1.8rem;">${product.price}</span>
                                ${product.originalPrice ? `<span class="original-price" style="font-size: 1.2rem;">${product.originalPrice}</span>` : ''}
                                ${product.badge ? `<span style="background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">${product.badge}</span>` : ''}
                            </div>
                            <p class="product-description">${product.details || product.description}</p>
                            
                            <div class="product-features">
                                <h4>Key Features</h4>
                                <ul>
                                    ${product.features ? product.features.map(feature => `
                                        <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-check" style="color: var(--success);"></i>
                                            ${feature}
                                        </li>
                                    `).join('') : '<li>No features listed</li>'}
                                </ul>
                            </div>
                            
                            <div class="quantity-selector">
                                <label>Quantity:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <button class="quantity-btn" onclick="updateQuantity(-1)">-</button>
                                    <input type="number" class="quantity-input" id="product-quantity" value="1" min="1">
                                    <button class="quantity-btn" onclick="updateQuantity(1)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('productModalAction').textContent = 'Add to Cart';
                document.getElementById('productModalAction').onclick = function() { addToCart(productId); };
                
                openModal('productModal');
            } catch (error) {
                console.error('Error showing product details:', error);
                showToast('Unable to load product details. Please try again.', 'error');
            }
        }

        // Get Started function for services
        async function getStarted(serviceId) {
            try {
                if (!currentUser) {
                    showToast('Please login to request this service', 'warning');
                    openAuthModal('login');
                    return;
                }
                
                const result = await createServiceRequest({
                    userId: currentUser.id,
                    serviceId: serviceId,
                    status: 'pending'
                });
                
                if (result.success) {
                    showToast('Service request submitted successfully! Our team will contact you shortly.', 'success');
                    closeModal('serviceModal');
                } else {
                    throw new Error(result.message || 'Failed to submit service request');
                }
            } catch (error) {
                console.error('Error getting started with service:', error);
                showToast('Unable to process your request. Please try again.', 'error');
            }
        }

        // Enroll Now function for courses
        async function enrollNow(courseId) {
            try {
                if (!currentUser) {
                    showToast('Please login to enroll in this course', 'warning');
                    openAuthModal('login');
                    return;
                }
                
                const result = await enrollInCourse(currentUser.id, courseId);
                
                if (result.success) {
                    showToast('Successfully enrolled in the course!', 'success');
                    closeModal('courseModal');
                } else {
                    throw new Error(result.message || 'Enrollment failed');
                }
            } catch (error) {
                console.error('Error enrolling in course:', error);
                showToast('Unable to enroll in course. Please try again.', 'error');
            }
        }

        // Add to cart function
        async function addToCart(productId) {
            try {
                if (!currentUser) {
                    showToast('Please login to add items to cart', 'warning');
                    openAuthModal('login');
                    return;
                }
                
                const quantity = parseInt(document.getElementById('product-quantity')?.value || 1);
                
                const result = await createOrder({
                    userId: currentUser.id,
                    productId: productId,
                    quantity: quantity,
                    status: 'pending'
                });
                
                if (result.success) {
                    showToast(`${quantity} item(s) added to cart!`, 'success');
                    closeModal('productModal');
                } else {
                    throw new Error(result.message || 'Failed to add to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Unable to add item to cart. Please try again.', 'error');
            }
        }

        // Update quantity function
        function updateQuantity(change) {
            const quantityInput = document.getElementById('product-quantity');
            if (quantityInput) {
                let quantity = parseInt(quantityInput.value);
                quantity = Math.max(1, quantity + change);
                quantityInput.value = quantity;
            }
        }

        // Dashboard Functions
        function showDashboard() {
            try {
                document.getElementById('home-content').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('dashboard').classList.add('active');
                updateDashboard();
            } catch (error) {
                console.error('Error showing dashboard:', error);
                showToast('Unable to load dashboard. Please try again.', 'error');
            }
        }

        function showHome() {
            try {
                document.getElementById('home-content').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('dashboard').classList.remove('active');
            } catch (error) {
                console.error('Error showing home:', error);
            }
        }

        function showDashboardTab(tabName) {
            try {
                document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.dashboard-tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                if (tabName === 'profile') {
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error showing dashboard tab:', error);
                showToast('Unable to load tab content. Please try again.', 'error');
            }
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            try {
                document.getElementById('enrolled-courses-count').textContent = currentUser.enrolledCourses ? currentUser.enrolledCourses.length : 0;
                document.getElementById('service-requests-count').textContent = currentUser.serviceRequests ? currentUser.serviceRequests.length : 0;
                document.getElementById('certificates-count').textContent = currentUser.certificates ? currentUser.certificates.length : 0;
                document.getElementById('learning-hours').textContent = currentUser.learningHours || 0;
                document.getElementById('user-greeting').textContent = currentUser.name.split(' ')[0];
                
                updateEnrolledCourses();
                updateServiceRequests();
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showToast('Unable to load dashboard data. Please try again.', 'error');
            }
        }

        function updateEnrolledCourses() {
            try {
                const container = document.getElementById('dashboard-courses');
                
                if (!currentUser.enrolledCourses || currentUser.enrolledCourses.length === 0) {
                    container.innerHTML = `
                        <div class="error-fallback">
                            <i class="fas fa-book-open"></i>
                            <h3>No Courses Enrolled</h3>
                            <p>You haven't enrolled in any courses yet. Browse our catalog to get started!</p>
                            <button class="btn btn-primary" onclick="showHome()">Browse Courses</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        container.innerHTML = currentUser.enrolledCourses.map(courseId => `
                            <div class="course-card">
                                <div class="course-image" style="background-image: url('https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80')">
                                    <div class="course-badge">ENROLLED</div>
                                </div>
                                <div class="course-content">
                                    <h3>Course ${courseId}</h3>
                                    <p>You are enrolled in this course. Continue your learning journey.</p>
                                    <div class="course-meta">
                                        <span><i class="fas fa-clock"></i> 12 weeks</span>
                                        <span><i class="fas fa-signal"></i> Intermediate</span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-primary" onclick="continueCourse('${courseId}')">
                                            <i class="fas fa-play"></i> Continue
                                        </button>
                                        <button class="btn btn-secondary" onclick="showCourseDetails('${courseId}')">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }, 1000);
                }
                
                document.getElementById('my-courses-list').innerHTML = container.innerHTML;
            } catch (error) {
                console.error('Error updating enrolled courses:', error);
                document.getElementById('dashboard-courses').innerHTML = `
                    <div class="error-fallback">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to Load Courses</h3>
                        <p>There was an error loading your enrolled courses. Please try again.</p>
                        <button class="btn btn-primary" onclick="updateEnrolledCourses()">Retry</button>
                    </div>
                `;
            }
        }

        function updateServiceRequests() {
            try {
                const container = document.getElementById('service-requests-list');
                
                if (!currentUser.serviceRequests || currentUser.serviceRequests.length === 0) {
                    container.innerHTML = `
                        <div class="error-fallback">
                            <i class="fas fa-tasks"></i>
                            <h3>No Service Requests</h3>
                            <p>You haven't submitted any service requests yet.</p>
                            <button class="btn btn-primary" onclick="showHome()">Browse Services</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = currentUser.serviceRequests.map(request => `
                        <div class="request-item">
                            <div>
                                <h4>Service Request #${request.id}</h4>
                                <p>Requested on ${new Date().toLocaleDateString()}</p>
                            </div>
                            <span class="request-status status-${request.status || 'pending'}">
                                ${(request.status || 'pending').replace('-', ' ').toUpperCase()}
                            </span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error updating service requests:', error);
                document.getElementById('service-requests-list').innerHTML = `
                    <div class="error-fallback">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to Load Service Requests</h3>
                        <p>There was an error loading your service requests. Please try again.</p>
                        <button class="btn btn-primary" onclick="updateServiceRequests()">Retry</button>
                    </div>
                `;
            }
        }

        function loadProfileData() {
            try {
                document.getElementById('profile-name').value = currentUser.name;
                document.getElementById('profile-email').value = currentUser.email;
                document.getElementById('profile-phone').value = currentUser.phone || '';
                document.getElementById('profile-company').value = currentUser.company || '';
                document.getElementById('profile-bio').value = currentUser.bio || '';
                document.getElementById('avatar-initials').textContent = getUserInitials(currentUser.name);
            } catch (error) {
                console.error('Error loading profile data:', error);
                showToast('Unable to load profile data. Please try again.', 'error');
            }
        }

        // Profile Update with API Integration
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            button.disabled = true;
            
            try {
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    email: document.getElementById('profile-email').value,
                    phone: document.getElementById('profile-phone').value,
                    company: document.getElementById('profile-company').value,
                    bio: document.getElementById('profile-bio').value
                };
                
                const result = await updateUserProfile(currentUser.id, profileData);
                
                if (result.success) {
                    currentUser = { ...currentUser, ...profileData };
                    localStorage.setItem(USER_DATA_KEY, JSON.stringify(currentUser));
                    
                    showToast('Profile updated successfully!', 'success');
                    updateAuthUI();
                } else {
                    throw new Error(result.message || 'Profile update failed');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // Continue course function
        function continueCourse(courseId) {
            try {
                showToast(`Continuing course ${courseId}`, 'info');
            } catch (error) {
                console.error('Error continuing course:', error);
                showToast('Unable to continue course. Please try again.', 'error');
            }
        }

        // Modal functions
        function openModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                
                const closeButton = modal.querySelector('.close-modal');
                if (closeButton) {
                    closeButton.focus();
                }
            } catch (error) {
                console.error('Error opening modal:', error);
                showToast('Unable to open details. Please try again.', 'error');
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        // Utility Functions
        function getUserInitials(name) {
            try {
                return name.split(' ').map(n => n[0]).join('').toUpperCase();
            } catch (error) {
                return 'U';
            }
        }

        function toggleUserDropdown() {
            try {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.toggle('show');
            } catch (error) {
                console.error('Error toggling user dropdown:', error);
            }
        }

        function logout() {
            try {
                currentUser = null;
                localStorage.removeItem(AUTH_TOKEN_KEY);
                localStorage.removeItem(USER_DATA_KEY);
                updateAuthUI();
                showHome();
                showToast('Logged out successfully', 'info');
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error logging out. Please try again.', 'error');
            }
        }

        function showToast(message, type = 'info') {
            try {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${getToastIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (container.contains(toast)) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            } catch (error) {
                console.error('Error showing toast:', error);
                alert(`${type.toUpperCase()}: ${message}`);
            }
        }

        function getToastIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Helper functions
        function getServiceIcon(category) {
            const icons = {
                'development': 'fa-code',
                'support': 'fa-headset',
                'testing': 'fa-bug',
                'cloud': 'fa-cloud',
                'security': 'fa-shield-alt',
                'analytics': 'fa-chart-bar',
                'infrastructure': 'fa-server',
                'database': 'fa-database',
                'consultation': 'fa-comments',
                'training': 'fa-graduation-cap',
                'design': 'fa-palette',
                'laptop': 'fa-laptop'
            };
            return icons[category] || 'fa-laptop-code';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            try {
                if (!e.target.closest('.user-menu')) {
                    const dropdown = document.getElementById('user-dropdown');
                    if (dropdown) dropdown.classList.remove('show');
                }
            } catch (error) {
                console.error('Error handling click outside dropdown:', error);
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initAuth();
                loadServices();
                loadCourses();
                loadProducts();
                
                // Add event listeners for search and filter
                document.getElementById('service-search').addEventListener('input', loadServices);
                document.getElementById('service-category').addEventListener('change', loadServices);
                document.getElementById('course-search').addEventListener('input', loadCourses);
                document.getElementById('course-level').addEventListener('change', loadCourses);
                document.getElementById('product-search').addEventListener('input', loadProducts);
                document.getElementById('product-category').addEventListener('change', loadProducts);
                
                // Add event listeners for the new social buttons
                document.querySelectorAll('.social-button').forEach(button => {
                    button.addEventListener('click', function() {
                        showToast('Social authentication coming soon!', 'info');
                    });
                });
                
                // Close modal when clicking outside
                window.onclick = function(event) {
                    if (event.target.classList.contains('modal')) {
                        event.target.style.display = 'none';
                        event.target.setAttribute('aria-hidden', 'true');
                    }
                }
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        const modals = document.querySelectorAll('.modal');
                        modals.forEach(modal => {
                            if (modal.style.display === 'flex') {
                                modal.style.display = 'none';
                                modal.setAttribute('aria-hidden', 'true');
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error initializing application:', error);
                document.body.innerHTML = `
                    <div style="padding: 50px; text-align: center;">
                        <h1>TechSolutions Pro</h1>
                        <p>We're experiencing technical difficulties. Please refresh the page or try again later.</p>
                        <button onclick="location.reload()" class="btn btn-primary">Refresh Page</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
